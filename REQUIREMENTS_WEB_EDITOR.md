# Требования к бекенду для веб-редактора кода

## Обзор функциональности

Необходимо реализовать полноценный веб-редактор кода, который позволит пользователям просматривать структуру проекта и редактировать файлы непосредственно в браузере. Редактор должен обеспечивать безопасную работу с файлами, сохранность данных и удобный пользовательский опыт.

## 1. API для получения структуры проекта

### 1.1 Получение дерева файлов и папок

**Эндпоинт:** `GET /projects/{projectId}/files/tree`

**Требования:**
- Возвращать полную иерархическую структуру проекта в виде дерева
- Поддерживать ленивую загрузку для больших проектов (опционально загружать содержимое папок по запросу)
- Включать метаданные для каждого элемента: тип (файл/папка), размер, дата изменения, права доступа
- Фильтрация системных файлов (.git, node_modules, .env и т.д.) с возможностью их отображения по запросу
- Поддержка поиска по именам файлов и папок
- Возможность получения структуры только определенной папки: `GET /projects/{projectId}/files/tree?path={folderPath}`

**Структура ответа должна включать:**
- Путь к файлу/папке
- Тип элемента (file/directory)
- Размер файла
- Дата последнего изменения
- Права доступа (read/write)
- MIME-тип файла для определения иконки и возможности редактирования
- Количество дочерних элементов для папок

### 1.2 Получение содержимого файла

**Эндпоинт:** `GET /projects/{projectId}/files/content`

**Параметры:**
- `filePath` - путь к файлу относительно корня проекта
- `encoding` - кодировка файла (по умолчанию UTF-8)

**Требования:**
- Поддержка различных кодировок
- Определение типа файла и соответствующего MIME-типа
- Возврат метаданных файла (размер, дата изменения, права доступа)
- Проверка прав доступа пользователя к файлу
- Обработка бинарных файлов (возврат информации о невозможности редактирования)
- Поддержка больших файлов с возможностью частичной загрузки

## 2. API для сохранения изменений

### 2.1 Сохранение содержимого файла

**Эндпоинт:** `PUT /projects/{projectId}/files/content`

**Тело запроса:**
- `filePath` - путь к файлу
- `content` - новое содержимое файла
- `encoding` - кодировка
- `lastModified` - временная метка последнего известного изменения (для проверки конфликтов)

**Требования:**
- Атомарность операции сохранения
- Проверка конфликтов (если файл был изменен другим пользователем)
- Валидация прав доступа
- Создание резервной копии перед изменением
- Проверка синтаксиса для определенных типов файлов (опционально)
- Возврат обновленных метаданных файла

### 2.2 Создание новых файлов и папок

**Эндпоинты:** 
- `POST /projects/{projectId}/files/create-file`
- `POST /projects/{projectId}/files/create-directory`

**Требования:**
- Проверка уникальности имени в директории
- Валидация имени файла/папки (недопустимые символы)
- Создание промежуточных директорий при необходимости
- Установка корректных прав доступа

### 2.3 Операции с файлами и папками

**Эндпоинты:**
- `DELETE /projects/{projectId}/files` - удаление
- `POST /projects/{projectId}/files/move` - перемещение/переименование
- `POST /projects/{projectId}/files/copy` - копирование

## 3. Real-time функциональность

### 3.1 WebSocket соединение

**Эндпоинт:** `WS /projects/{projectId}/editor/ws`

**Требования:**
- Установка WebSocket соединения для real-time обновлений
- Уведомления о изменениях файлов другими пользователями
- Показ активности других пользователей (кто какой файл редактирует)
- Синхронизация курсора и выделения текста между пользователями (если планируется совместное редактирование)

### 3.2 Типы WebSocket сообщений

**Входящие сообщения:**
- `file_opened` - пользователь открыл файл
- `file_closed` - пользователь закрыл файл
- `content_changed` - изменение содержимого файла
- `cursor_moved` - перемещение курсора (для collaborative editing)

**Исходящие сообщения:**
- `file_modified` - файл был изменен другим пользователем
- `user_joined` - новый пользователь подключился к проекту
- `user_left` - пользователь покинул проект
- `active_users` - список активных пользователей

## 4. Система версионирования и резервного копирования

### 4.1 История изменений

**Эндпоинт:** `GET /projects/{projectId}/files/history`

**Требования:**
- Ведение истории изменений каждого файла
- Возможность просмотра предыдущих версий
- Возможность отката к предыдущей версии
- Сравнение версий (diff)
- Информация о пользователе, внесшем изменения
- Временные метки изменений

### 4.2 Автоматическое сохранение

**Требования:**
- Периодическое создание снапшотов состояния файлов
- Восстановление несохраненных изменений при повторном входе
- Временные файлы для draft-версий

## 5. Безопасность и валидация

### 5.1 Проверка прав доступа

**Требования:**
- Проверка прав пользователя на чтение/запись для каждого файла
- Ограничение доступа к системным файлам
- Валидация путей файлов (предотвращение directory traversal атак)
- Ограничение размера загружаемых файлов

### 5.2 Валидация содержимого

**Требования:**
- Проверка на вредоносный код в загружаемых файлах
- Ограничение типов файлов, которые можно редактировать
- Валидация синтаксиса для определенных типов файлов
- Санитизация пользовательского ввода

## 6. Производительность и оптимизация

### 6.1 Кэширование

**Требования:**
- Кэширование содержимого файлов на стороне сервера
- Поддержка ETag для условных запросов
- Кэширование структуры проекта
- Инвалидация кэша при изменениях

### 6.2 Обработка больших файлов

**Требования:**
- Ограничение размера файлов, доступных для редактирования
- Потоковая загрузка больших файлов
- Пагинация для файлов с большим количеством строк
- Предупреждения о производительности для больших файлов

## 7. Интеграция с существующей системой

### 7.1 Связь с проектами

**Требования:**
- Использование существующей системы аутентификации
- Интеграция с существующими API проектов
- Поддержка системы ролей и разрешений
- Связь файлов с конкретными проектами

### 7.2 Мониторинг и логирование

**Требования:**
- Логирование всех операций с файлами
- Мониторинг производительности
- Отслеживание ошибок и исключений
- Метрики использования редактора

## 8. Рекомендации по стратегии сохранения

### 8.1 Автосохранение vs ручное сохранение

**Рекомендуется гибридный подход:**

**Автосохранение draft-версий:**
- Автоматическое сохранение изменений каждые 30-60 секунд в временные файлы
- Сохранение происходит в background без уведомления пользователя
- Draft-версии не влияют на основную версию файла
- Восстановление draft при повторном открытии файла

**Ручное сохранение основной версии:**
- Пользователь явно сохраняет изменения через Ctrl+S или кнопку "Сохранить"
- Ручное сохранение создает новую версию в истории изменений
- Показ индикатора несохраненных изменений (точка или звездочка в имени файла)
- Предупреждение при попытке закрыть файл с несохраненными изменениями

### 8.2 Преимущества гибридного подхода

**Безопасность данных:**
- Пользователь не теряет работу при случайном закрытии браузера
- Возможность восстановления после сбоев
- Контроль над тем, что считается "финальной" версией

**Пользовательский опыт:**
- Привычный для разработчиков workflow
- Возможность экспериментировать без страха потери данных
- Четкое понимание, когда изменения зафиксированы

**Производительность:**
- Снижение нагрузки на сервер за счет менее частых "финальных" сохранений
- Возможность оптимизации автосохранения (например, сохранять только дельты)

### 8.3 Технические детали реализации

**Автосохранение:**
- Создание отдельной таблицы/коллекции для draft-версий
- Включение user_id, project_id, file_path, content, timestamp
- Периодическая очистка старых draft-версий
- Сжатие содержимого для экономии места

**Ручное сохранение:**
- Транзакционное обновление основного файла
- Создание записи в истории версий
- Удаление соответствующего draft после успешного сохранения
- Уведомление других пользователей через WebSocket

## 9. Дополнительные возможности (опционально)

### 9.1 Расширенная функциональность

- Поддержка плагинов для различных языков программирования
- Интеграция с системами контроля версий (Git)
- Поиск и замена по всему проекту
- Форматирование кода
- Подсветка синтаксиса на сервере для предварительного просмотра

### 9.2 Collaborative editing

- Operational Transformation для синхронизации изменений
- Показ курсоров других пользователей
- Разрешение конфликтов при одновременном редактировании
- Система блокировок для предотвращения конфликтов

Данный документ предоставляет полное техническое задание для реализации веб-редактора кода на бекенде. Реализация всех компонентов обеспечит современный и удобный опыт разработки прямо в браузере.
