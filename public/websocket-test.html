<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
</head>
<body>
    <h1>WebSocket Test</h1>
    <div id="status">Disconnected</div>
    <div id="logs"></div>

    <script>
        const projectId = '11';
        const statusDiv = document.getElementById('status');
        const logsDiv = document.getElementById('logs');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            console.log(message);
        }

        log('–¢–µ—Å—Ç–∏—Ä—É–µ–º WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥-–ø—Ä–æ–∫—Å–∏...');

        // –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥-–ø—Ä–æ–∫—Å–∏ (–ø–æ—Ä—Ç 3000)
        const socket = io('/projects', {
            query: { projectId },
            transports: ['websocket'],
        });

        socket.on('connect', () => {
            log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
            statusDiv.textContent = 'Connected';
            statusDiv.style.color = 'green';

            // –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è
            socket.emit('file_opened', { filePath: '/test/file.txt' });
            log('üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ file_opened');
        });

        socket.on('connect_error', (error) => {
            log('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
            statusDiv.textContent = 'Connection Error';
            statusDiv.style.color = 'red';
        });

        socket.on('disconnect', (reason) => {
            log('üîå –û—Ç–∫–ª—é—á–µ–Ω–æ: ' + reason);
            statusDiv.textContent = 'Disconnected';
            statusDiv.style.color = 'orange';
        });

        socket.on('active_users', (data) => {
            log('üë• –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: ' + JSON.stringify(data.users));
        });

        socket.on('user_joined', (data) => {
            log('üö™ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è: ' + JSON.stringify(data));
        });

        socket.on('user_left', (data) => {
            log('üö™ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª: ' + JSON.stringify(data));
        });

        socket.on('file_opened', (data) => {
            log('üìÇ –§–∞–π–ª –æ—Ç–∫—Ä—ã—Ç: ' + JSON.stringify(data));
        });

        // –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±—ç–∫–µ–Ω–¥—É —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            log('–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±—ç–∫–µ–Ω–¥—É...');

            const directSocket = io('ws://localhost:8000/projects', {
                query: { projectId },
                transports: ['websocket'],
            });

            directSocket.on('connect', () => {
                log('‚úÖ –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±—ç–∫–µ–Ω–¥—É —É—Å–ø–µ—à–Ω–æ!');
            });

            directSocket.on('connect_error', (error) => {
                log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä—è–º–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±—ç–∫–µ–Ω–¥—É: ' + error.message);
            });
        }, 5000);
    </script>
</body>
</html>