<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Debug</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
</head>
<body>
    <h1>ğŸ” WebSocket Debug</h1>
    <div id="status">Disconnected</div>
    <div id="logs"></div>

    <script>
        const projectId = '11';
        const statusDiv = document.getElementById('status');
        const logsDiv = document.getElementById('logs');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            console.log(message);
        }

        log('ğŸš€ Starting WebSocket debug...');
        log('ğŸ“ Current location: ' + window.location.href);
        log('ğŸ”§ NEXT_PUBLIC_WS_URL: ' + (process?.env?.NEXT_PUBLIC_WS_URL || 'not available'));

        // Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´-Ğ¿Ñ€Ğ¾ĞºÑĞ¸ (Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ñ‹Ğ¹ ÑĞ¿Ğ¾ÑĞ¾Ğ±)
        log('ğŸ“¡ Attempting connection via proxy (recommended)...');

        const socket = io('/projects', {
            query: { projectId },
            transports: ['websocket', 'polling'],
            forceNew: true,
            timeout: 10000,
        });

        socket.on('connect', () => {
            log('âœ… SUCCESS: WebSocket connected via proxy!');
            statusDiv.textContent = 'Connected via Proxy';
            statusDiv.style.color = 'green';

            // Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºÑƒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
            socket.emit('file_opened', { filePath: '/test/file.txt' });
            log('ğŸ“¤ Sent test message');
        });

        socket.on('disconnect', (reason) => {
            log('âŒ WebSocket disconnected: ' + reason);
            statusDiv.textContent = 'Disconnected: ' + reason;
            statusDiv.style.color = 'orange';
        });

        socket.on('connect_error', (error) => {
            log('âŒ CONNECTION ERROR: ' + error.message);
            log('âŒ Error details:', error);
            statusDiv.textContent = 'Connection Error: ' + error.message;
            statusDiv.style.color = 'red';

            // Fallback: Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¿Ñ€ÑĞ¼Ğ¾Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ
            setTimeout(() => {
                log('ğŸ”„ Trying direct connection to backend...');
                testDirectConnection();
            }, 2000);
        });

        function testDirectConnection() {
            const directSocket = io('ws://localhost:8000/projects', {
                query: { projectId },
                transports: ['websocket'],
                forceNew: true,
            });

            directSocket.on('connect', () => {
                log('âœ… SUCCESS: Direct connection to backend works!');
            });

            directSocket.on('connect_error', (error) => {
                log('âŒ DIRECT CONNECTION ALSO FAILED: ' + error.message);
            });
        }

        // Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²ÑĞµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ´Ğ»Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ¸
        socket.on('reconnect_attempt', (attempt) => {
            log('ğŸ”„ Reconnection attempt #' + attempt);
        });

        socket.on('reconnect', (attempt) => {
            log('âœ… Reconnected after ' + attempt + ' attempts');
        });

        socket.on('reconnect_error', (error) => {
            log('âŒ Reconnection failed: ' + error.message);
        });

        // Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
        socket.on('active_users', (data) => {
            log('ğŸ‘¥ Active users: ' + JSON.stringify(data.users));
        });

        socket.on('user_joined', (data) => {
            log('ğŸšª User joined: ' + JSON.stringify(data));
        });

        socket.on('file_opened', (data) => {
            log('ğŸ“‚ File opened: ' + JSON.stringify(data));
        });
    </script>
</body>
</html>